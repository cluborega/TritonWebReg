---------------MILESTONE 5 SOLUTION -------------------

--CREATE CPQG TABLE

SELECT CO.ID AS COURSE_ID,CL.id AS CLASS_ID ,CO.COURSENUMBER, TH.FACULTY,Q.QUARTER,Q.YEAR,
COUNT(CASE WHEN grade_received IN('A+','A','A-') THEN 1 END) AS 'A',
COUNT(CASE WHEN grade_received IN('B','B+', 'B-') THEN 1 END) AS 'B',
COUNT(CASE WHEN grade_received IN('C','C+','C-') THEN 1 END) AS 'C',
COUNT(CASE WHEN grade_received IN('D') THEN 1 END) AS 'D',
COUNT(CASE WHEN grade_received IN('F','S','U') THEN 1 END) AS 'OTHER'
INTO CPQG FROM COURSE CO 
JOIN COURSE_WITHCLASS CWC ON CO.id = CWC.COURSE_ID
JOIN CLASS CL ON CWC.CLASS_ID = CL.id
JOIN TEACHINGHISTORY TH ON TH.CLASS_ID = CL.id
JOIN QUARTER Q ON CL.QUARTER = Q.QUARTER AND CL.CLASS_YEAR = Q.YEAR 
JOIN CLASSESTAKEN CT ON CT.CLASS_ID = TH.CLASS_ID
GROUP BY CO.id, TH.FACULTY,CO.COURSENUMBER, Q.QUARTER,Q.YEAR,CL.id


--CREATE CPG TABLE
SELECT CO.ID AS COURSE_ID,CL.id AS CLASS_ID ,CO.COURSENUMBER, TH.FACULTY,
COUNT(CASE WHEN grade_received IN('A+','A','A-') THEN 1 END) AS 'A',
COUNT(CASE WHEN grade_received IN('B','B+', 'B-') THEN 1 END) AS 'B',
COUNT(CASE WHEN grade_received IN('C','C+','C-') THEN 1 END) AS 'C',
COUNT(CASE WHEN grade_received IN('D') THEN 1 END) AS 'D',
COUNT(CASE WHEN grade_received IN('F','S','U') THEN 1 END) AS 'OTHER'
INTO CPG FROM COURSE CO 
JOIN COURSE_WITHCLASS CWC ON CO.id = CWC.COURSE_ID
JOIN CLASS CL ON CWC.CLASS_ID = CL.id
JOIN TEACHINGHISTORY TH ON TH.CLASS_ID = CL.id 
JOIN CLASSESTAKEN CT ON CT.CLASS_ID = TH.CLASS_ID
GROUP BY CO.id, TH.FACULTY,CO.COURSENUMBER,CL.id


--UPDATE CPQG AND CPG ON INSERT GRADE
ALTER TRIGGER cpqg_update_on_insert 
ON CLASSESTAKEN
AFTER INSERT AS 
BEGIN

	--DECLARE @OLD_FACULTY VARCHAR(40)
	--DECLARE @OLD_GRADE VARCHAR(5)
	--DECLARE @OLD_CLASSID INT
	
	DECLARE @NEW_CLASSID INT
	DECLARE @NEW_FACULTY VARCHAR(40)
	DECLARE @NEW_GRADE VARCHAR(5)
	

	SELECT @NEW_CLASSID = CLASS_ID FROM inserted
	SELECT @NEW_GRADE = GRADE_RECEIVED FROM inserted
	
	
	PRINT @NEW_CLASSID
	PRINT @NEW_GRADE
	
	SELECT CL.ID AS CL_ID,COR.ID AS CO_ID,COR.COURSENUMBER AS CO_NUM, FACULTY, Q.QUARTER, Q.YEAR INTO #TEMP1 FROM CLASSESTAKEN CT
	JOIN CLASS CL ON CL.ID = CT.CLASS_ID
	JOIN TEACHINGHISTORY TH ON TH.CLASS_ID = CL.ID
	JOIN QUARTER Q ON Q.QUARTER = CL.QUARTER AND CL.CLASS_YEAR = Q.YEAR
	JOIN COURSE_WITHCLASS CWC ON CWC.CLASS_ID = CL.ID
	JOIN COURSE COR ON COR.ID = CWC.COURSE_ID
	WHERE 
	CL.ID = @NEW_CLASSID
	GROUP BY CL.ID, COR.ID,COR.COURSENUMBER, FACULTY, Q.QUARTER, Q.YEAR
	
	
	IF((SELECT COUNT(*) FROM CPQG WHERE 
		COURSE_ID = (SELECT CO_ID FROM #TEMP1) AND 
		CLASS_ID = (SELECT CL_ID FROM #TEMP1) AND
		FACULTY = (SELECT FACULTY FROM #TEMP1) AND
		QUARTER = (SELECT QUARTER FROM #TEMP1) AND
		YEAR = (SELECT YEAR FROM #TEMP1))=0)
	BEGIN
		INSERT INTO CPQG (COURSE_ID, CLASS_ID, COURSENUMBER, FACULTY,QUARTER, YEAR,A,B,C,D,OTHER)
		SELECT CO_ID,CL_ID,CO_NUM,FACULTY,QUARTER,YEAR,0,0,0,0,0 FROM #TEMP1
		
		INSERT INTO CPG (COURSE_ID, CLASS_ID, COURSENUMBER, FACULTY,A,B,C,D,OTHER)
		SELECT CO_ID,CL_ID,CO_NUM, FACULTY,0,0,0,0,0 FROM #TEMP1
		
	END
	
	UPDATE CPQG SET 
	"A" = CASE WHEN @NEW_GRADE IN ('A','A+','A-') THEN "A" + 1 ELSE "A" END,
	"B" = CASE WHEN @NEW_GRADE IN ('B','B+','B-') THEN "B" + 1 ELSE "B" END,	
	"C" = CASE WHEN @NEW_GRADE IN ('C','C+','C-') THEN "C" + 1 ELSE "C" END,	
	"D" = CASE WHEN @NEW_GRADE ='D' THEN "D" + 1 ELSE "D" END,
	"OTHER" = CASE WHEN @NEW_GRADE IN ('F','S','U') THEN "OTHER" + 1 ELSE "OTHER" END
	WHERE 
	COURSE_ID = (SELECT CO_ID FROM #TEMP1) AND 
	CLASS_ID = (SELECT CL_ID FROM #TEMP1) AND
	FACULTY = (SELECT FACULTY FROM #TEMP1) AND
	QUARTER = (SELECT QUARTER FROM #TEMP1) AND
	YEAR = (SELECT YEAR FROM #TEMP1)
	
	
	UPDATE CPG SET 
	"A" = CASE WHEN @NEW_GRADE IN ('A','A+','A-') THEN "A" + 1 ELSE "A" END,
	"B" = CASE WHEN @NEW_GRADE IN ('B','B+','B-') THEN "B" + 1 ELSE "B" END,	
	"C" = CASE WHEN @NEW_GRADE IN ('C','C+','C-') THEN "C" + 1 ELSE "C" END,	
	"D" = CASE WHEN @NEW_GRADE ='D' THEN "D" + 1 ELSE "D" END,
	"OTHER" = CASE WHEN @NEW_GRADE IN ('F','S','U') THEN "OTHER" + 1 ELSE "OTHER" END
	WHERE 
	COURSE_ID = (SELECT CO_ID FROM #TEMP1) AND 
	CLASS_ID = (SELECT CL_ID FROM #TEMP1) AND
	FACULTY = (SELECT FACULTY FROM #TEMP1)
	
	DROP TABLE #TEMP1
	
END


-----------------------------------------------------

--UPDATE CPG AND CPG ON UPDATE GRADE
ALTER TRIGGER cpqg_update_on_UPDATE 
ON CLASSESTAKEN
FOR UPDATE AS 
BEGIN


	DECLARE @OLD_GRADE VARCHAR(5)

	
	DECLARE @NEW_CLASSID1 INT
	DECLARE @NEW_FACULTY1 VARCHAR(40)
	DECLARE @NEW_GRADE1 VARCHAR(5)

	SELECT @NEW_CLASSID1 = CLASS_ID FROM inserted
	SELECT @NEW_GRADE1 = GRADE_RECEIVED FROM inserted
	SELECT @OLD_GRADE = GRADE_RECEIVED FROM deleted
	
	PRINT @NEW_CLASSID1
	PRINT @NEW_GRADE1
	PRINT @OLD_GRADE
	
	SELECT CL.ID AS CL_ID,COR.ID AS CO_ID,COR.COURSENUMBER AS CO_NUM, FACULTY, Q.QUARTER, Q.YEAR INTO #TEMP1 FROM CLASSESTAKEN CT
	JOIN CLASS CL ON CL.ID = CT.CLASS_ID
	JOIN TEACHINGHISTORY TH ON TH.CLASS_ID = CL.ID
	JOIN QUARTER Q ON Q.QUARTER = CL.QUARTER AND CL.CLASS_YEAR = Q.YEAR
	JOIN COURSE_WITHCLASS CWC ON CWC.CLASS_ID = CL.ID
	JOIN COURSE COR ON COR.ID = CWC.COURSE_ID
	WHERE 
	CL.ID = @NEW_CLASSID1
	GROUP BY CL.ID, COR.ID,COR.COURSENUMBER, FACULTY, Q.QUARTER, Q.YEAR
	
	
	UPDATE CPQG SET 
	"A" = CASE WHEN @NEW_GRADE1 IN ('A','A+','A-') THEN "A" + 1 ELSE "A" END,
	"B" = CASE WHEN @NEW_GRADE1 IN ('B','B+','B-') THEN "B" + 1 ELSE "B" END,	
	"C" = CASE WHEN @NEW_GRADE1 IN ('C','C+','C-') THEN "C" + 1 ELSE "C" END,	
	"D" = CASE WHEN @NEW_GRADE1 ='D' THEN "D" + 1 ELSE "D" END,
	"OTHER" = CASE WHEN @NEW_GRADE1 IN ('F','S','U') THEN "OTHER" + 1 ELSE "OTHER" END
	WHERE 
	COURSE_ID = (SELECT CO_ID FROM #TEMP1) AND 
	CLASS_ID = (SELECT CL_ID FROM #TEMP1) AND
	FACULTY = (SELECT FACULTY FROM #TEMP1) AND
	QUARTER = (SELECT QUARTER FROM #TEMP1) AND
	YEAR = (SELECT YEAR FROM #TEMP1)
	
		
	UPDATE CPQG SET 
	"A" = CASE WHEN @OLD_GRADE IN ('A','A+','A-') THEN "A" - 1 ELSE "A" END,
	"B" = CASE WHEN @OLD_GRADE IN ('B','B+','B-') THEN "B" - 1 ELSE "B" END,	
	"C" = CASE WHEN @OLD_GRADE IN ('C','C+','C-') THEN "C" - 1 ELSE "C" END,	
	"D" = CASE WHEN @OLD_GRADE ='D' THEN "D" - 1 ELSE "D" END,
	"OTHER" = CASE WHEN @OLD_GRADE IN ('F','S','U') THEN "OTHER" - 1 ELSE "OTHER" END
	WHERE 
	COURSE_ID = (SELECT CO_ID FROM #TEMP1) AND 
	CLASS_ID = (SELECT CL_ID FROM #TEMP1) AND
	FACULTY = (SELECT FACULTY FROM #TEMP1) AND
	QUARTER = (SELECT QUARTER FROM #TEMP1) AND
	YEAR = (SELECT YEAR FROM #TEMP1)
	
	
	UPDATE CPG SET 
	"A" = CASE WHEN @NEW_GRADE1 IN ('A','A+','A-') THEN "A" + 1 ELSE "A" END,
	"B" = CASE WHEN @NEW_GRADE1 IN ('B','B+','B-') THEN "B" + 1 ELSE "B" END,	
	"C" = CASE WHEN @NEW_GRADE1 IN ('C','C+','C-') THEN "C" + 1 ELSE "C" END,	
	"D" = CASE WHEN @NEW_GRADE1 ='D' THEN "D" + 1 ELSE "D" END,
	"OTHER" = CASE WHEN @NEW_GRADE1 IN ('F','S','U') THEN "OTHER" + 1 ELSE "OTHER" END
	WHERE 
	COURSE_ID = (SELECT CO_ID FROM #TEMP1) AND 
	CLASS_ID = (SELECT CL_ID FROM #TEMP1) AND
	FACULTY = (SELECT FACULTY FROM #TEMP1)
	
	
	UPDATE CPG SET 
	"A" = CASE WHEN @OLD_GRADE IN ('A','A+','A-') THEN "A" - 1 ELSE "A" END,
	"B" = CASE WHEN @OLD_GRADE IN ('B','B+','B-') THEN "B" - 1 ELSE "B" END,	
	"C" = CASE WHEN @OLD_GRADE IN ('C','C+','C-') THEN "C" - 1 ELSE "C" END,	
	"D" = CASE WHEN @OLD_GRADE ='D' THEN "D" - 1 ELSE "D" END,
	"OTHER" = CASE WHEN @OLD_GRADE IN ('F','S','U') THEN "OTHER" - 1 ELSE "OTHER" END
	WHERE 
	COURSE_ID = (SELECT CO_ID FROM #TEMP1) AND 
	CLASS_ID = (SELECT CL_ID FROM #TEMP1) AND
	FACULTY = (SELECT FACULTY FROM #TEMP1)
	
	DROP TABLE #TEMP1
	
END

